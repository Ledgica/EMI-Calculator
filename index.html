<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgica EMI Calculator</title>
    <!-- Import Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Import required fonts -->
    <link href="https://fonts.cdnfonts.com/css/league-spartan" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Meshed Display Black';
            src: url('https://cdn.jsdelivr.net/gh/dafont-proxy/meshed@latest/Meshed-Display-Black.woff2') format('woff2');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            /* Color scheme */
            --color-onyx: #2d2d2d;
            --color-onyx-lighter: #3a3a3a;
            --color-onyx-darker: #222222;
            --color-purple: #8A4FFF;
            --color-purple-dark: #7039e6;
            --color-purple-light: #A77BFF;
            --color-blue: #4F9DFF;
            --color-blue-dark: #3d8aea;
            --color-blue-light: #7BB8FF;
            --color-red: #FF5B5B;
            --color-red-dark: #e04a4a;
            --color-green: #38C976;
            --color-green-dark: #2eaf64;
            --color-white: #ffffff;
            --color-white-dim: rgba(255, 255, 255, 0.85);
            --color-white-dimmer: rgba(255, 255, 255, 0.65);
            --color-white-dimmest: rgba(255, 255, 255, 0.45);
            
            /* Shadows (Apple-inspired) */
            --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            
            /* Typography */
            --font-heading: 'Meshed Display Black', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: 'League Spartan', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* Spacing & Radius (Apple-inspired) */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%;
            font-size: 16px;
        }

        body {
            min-height: 100%;
            font-family: var(--font-body);
            line-height: 1.5;
            color: var(--color-white);
            background-color: var(--color-onyx);
            padding: var(--space-md);
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-md) 0;
        }

        /* Text styles */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 900;
            letter-spacing: -0.02em;
            line-height: 1.1;
            margin-bottom: var(--space-md);
        }

        h1 {
            font-size: 2.5rem;
        }
        
        h2 {
            font-size: 2rem;
        }

        h3 {
            font-size: 1.5rem;
        }

        p {
            margin-bottom: var(--space-md);
        }

        /* Brand header */
        .brand-header {
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .brand-name {
            font-family: var(--font-heading);
            font-size: 2rem;
            font-weight: 900;
            color: var(--color-white);
            letter-spacing: -0.02em;
        }

        /* App header */
        .app-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--space-xl);
            text-align: center;
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--color-purple-light) 0%, var(--color-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .app-subtitle {
            font-size: 1.25rem;
            color: var(--color-white-dimmer);
            max-width: 600px;
        }

        /* Cards */
        .card {
            background-color: var(--color-onyx-lighter);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .section-title {
            font-family: var(--font-heading);
            font-size: 1.75rem;
            font-weight: 900;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-white);
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .form-group {
            margin-bottom: var(--space-sm);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 600;
            color: var(--color-white);
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition-fast);
            color: var(--color-white);
            background-color: var(--color-onyx-darker);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) inset;
            font-family: var(--font-body);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(138, 79, 255, 0.25);
        }

        select.form-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-hint {
            display: block;
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--color-white-dimmest);
        }

        /* Buttons */
        .button-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .button {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            box-shadow: var(--shadow-sm);
            font-family: var(--font-body);
        }

        .button-primary {
            background: linear-gradient(135deg, var(--color-purple) 0%, var(--color-blue) 100%);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-purple-dark) 0%, var(--color-blue-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .button-success {
            background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-green) 100%);
            color: white;
        }

        .button-success:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-blue-dark) 0%, var(--color-green-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Results section */
        .results-section {
            display: none;
        }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .summary-card {
            background-color: var(--color-onyx-darker);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition: var(--transition-normal);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--shadow-sm);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: rgba(138, 79, 255, 0.2);
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--color-white-dimmer);
            margin-bottom: var(--space-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-purple) 0%, var(--color-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        /* Loan progress section */
        .progress-section {
            margin-bottom: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--color-onyx-darker);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-filled {
            height: 100%;
            background: linear-gradient(90deg, var(--color-blue) 0%, var(--color-purple) 100%);
            border-radius: var(--radius-full);
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--color-white-dimmer);
        }

        .progress-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .progress-stat {
            background-color: var(--color-onyx-darker);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition-normal);
        }

        .progress-stat:hover {
            transform: translateY(-3px);
            border-color: rgba(79, 157, 255, 0.2);
        }

        .progress-label {
            font-size: 0.85rem;
            color: var(--color-white-dimmer);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .progress-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
        }

        .completed {
            background: linear-gradient(135deg, var(--color-green) 0%, var(--color-blue) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .remaining {
            background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-purple) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        /* Table styles */
        .table-container {
            margin-bottom: var(--space-lg);
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background-color: var(--color-onyx-darker);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background-color: var(--color-onyx-darker);
            color: var(--color-white);
            font-weight: 600;
            text-align: left;
            padding: 14px 16px;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(138, 79, 255, 0.3);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--color-white-dim);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: rgba(255, 255, 255, 0.03);
        }

        tr.paid-row td {
            background-color: rgba(56, 201, 118, 0.05);
        }

        tr.paid-row:hover td {
            background-color: rgba(56, 201, 118, 0.1);
        }

        tr.current-row td {
            background-color: rgba(138, 79, 255, 0.1);
            border-bottom: 1px solid var(--color-purple);
            border-top: 1px solid var(--color-purple);
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .principal-amount {
            color: var(--color-blue);
            font-weight: 600;
        }

        .interest-amount {
            color: var(--color-purple);
            font-weight: 600;
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-paid {
            background-color: rgba(56, 201, 118, 0.15);
            color: var(--color-green);
        }

        .badge-current {
            background-color: rgba(138, 79, 255, 0.15);
            color: var(--color-purple);
        }

        .badge-pending {
            background-color: rgba(79, 157, 255, 0.15);
            color: var(--color-blue);
        }

        /* Chart section */
        .chart-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: var(--space-lg);
            background-color: var(--color-onyx-darker);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--shadow-sm);
            gap: var(--space-lg);
            transition: var(--transition-normal);
        }

        .chart-section:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: rgba(138, 79, 255, 0.2);
        }

        .chart-container {
            width: 280px;
            height: 280px;
            position: relative;
            margin: 0 auto;
        }

        .chart-info {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chart-title {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            color: var(--color-white);
            margin-bottom: var(--space-md);
            text-align: center;
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            color: var(--color-white-dim);
            padding: var(--space-xs) 0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        /* Footer */
        footer {
            text-align: center;
            color: var(--color-white-dimmest);
            font-size: 0.85rem;
            margin-top: var(--space-xl);
            padding: var(--space-md) 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .copyright {
            margin-top: var(--space-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: var(--space-sm);
            }
            
            .container {
                padding: var(--space-sm) 0;
            }
            
            .card {
                padding: var(--space-md);
            }
            
            .form-grid, 
            .button-container,
            .summary-grid,
            .progress-summary {
                grid-template-columns: 1fr;
            }

            .chart-section {
                flex-direction: column;
                align-items: center;
                padding: var(--space-md);
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="brand-header">
            <h1 class="brand-name">Ledgica Private Limited</h1>
        </div>
        
        <div class="app-header">
            <h2 class="app-title">Loan EMI Calculator</h2>
            <p class="app-subtitle">Calculate your loan EMI, view the complete repayment schedule, and plan your finances better</p>
        </div>
        
        <div class="card">
            <h3 class="section-title">Loan Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="loanAmount">Loan Amount</label>
                    <input type="number" class="form-input" id="loanAmount" min="1" step="any" value="500000" required>
                    <span class="form-hint">Enter the total loan amount</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="interestRate">Annual Interest Rate (%)</label>
                    <input type="number" class="form-input" id="interestRate" min="0.01" step="any" value="9.5" required>
                    <span class="form-hint">Enter the annual interest rate</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="loanTerm">Loan Term (Months)</label>
                    <input type="number" class="form-input" id="loanTerm" min="1" step="1" value="60" required>
                    <span class="form-hint">Enter the total loan duration in months</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="startMonth">Loan Start Month</label>
                    <select class="form-input" id="startMonth" required>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <span class="form-hint">Select the month when the loan started</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="startYear">Loan Start Year</label>
                    <select class="form-input" id="startYear" required>
                        <!-- Will be populated with JavaScript -->
                    </select>
                    <span class="form-hint">Select the year when the loan started</span>
                </div>
            </div>
            
            <div class="button-container">
                <button type="button" class="button button-primary" id="calculateBtn" onclick="calculateEMI()">
                    Calculate EMI
                </button>
                
                <button type="button" class="button button-success" id="exportBtn" disabled onclick="exportToExcel()">
                    Export to Excel
                </button>
            </div>
        </div>
        
        <div id="results" class="results-section">
            <div class="card">
                <h3 class="section-title">Loan Summary</h3>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Monthly EMI</div>
                        <div id="monthlyEMI" class="summary-value">₹0</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-label">Total Interest</div>
                        <div id="totalInterest" class="summary-value">₹0</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-label">Total Payment</div>
                        <div id="totalPayment" class="summary-value">₹0</div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-label">Interest Ratio</div>
                        <div id="interestRatio" class="summary-value">0%</div>
                    </div>
                </div>
                
                <!-- Payment Progress Section -->
                <div class="progress-section">
                    <h3 class="section-title">Loan Progress</h3>
                    
                    <div class="progress-bar-container">
                        <div class="progress-filled" id="progressBar" style="width: 0%"></div>
                    </div>
                    
                    <div class="progress-info">
                        <span>Start: <span id="loanStartDate">Jan 2023</span></span>
                        <span>Current: <span id="currentDate">Mar 2023</span></span>
                        <span>End: <span id="loanEndDate">Jan 2028</span></span>
                    </div>
                    
                    <div class="progress-summary">
                        <div class="progress-stat">
                            <div class="progress-label">Months Completed</div>
                            <div class="progress-value completed" id="monthsCompleted">0</div>
                        </div>
                        
                        <div class="progress-stat">
                            <div class="progress-label">Months Remaining</div>
                            <div class="progress-value remaining" id="monthsRemaining">0</div>
                        </div>
                        
                        <div class="progress-stat">
                            <div class="progress-label">Principal Paid</div>
                            <div class="progress-value completed" id="principalPaid">₹0</div>
                        </div>
                        
                        <div class="progress-stat">
                            <div class="progress-label">Principal Remaining</div>
                            <div class="progress-value remaining" id="principalRemaining">₹0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Section -->
                <div class="chart-section">
                    <div class="chart-container">
                        <canvas id="loanChart"></canvas>
                    </div>
                    <div class="chart-info">
                        <h3 class="chart-title">Loan Composition</h3>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #4F9DFF;"></div>
                                <span>Principal Amount: <span id="principalValue">₹0</span> (<span id="principalPercentage">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #8A4FFF;"></div>
                                <span>Total Interest: <span id="interestValue">₹0</span> (<span id="interestPercentage">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <strong>Total Repayment: <span id="totalValue">₹0</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title">Repayment Schedule</h3>
                
                <div class="table-responsive">
                    <table id="repaymentTable">
                        <thead>
                            <tr>
                                <th class="text-center">No.</th>
                                <th>Payment Date</th>
                                <th class="text-center">Status</th>
                                <th class="text-right">EMI</th>
                                <th class="text-right">Principal</th>
                                <th class="text-right">Interest</th>
                                <th class="text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>This calculator is designed for informational purposes only. Actual loan terms and conditions may vary by lender.</p>
        <div class="copyright">
            <span>© 2025 Ledgica Private Limited. All rights reserved.</span>
        </div>
    </footer>

<script>
// Global variables
let loanChart = null;
let calculationResults = {}; // Store calculation results for export

// Populate year dropdown when the page loads
window.addEventListener('load', function() {
    populateYearDropdown();
    
    // Set default month to current month
    const currentMonth = new Date().getMonth();
    document.getElementById('startMonth').value = currentMonth;
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.warn("Chart.js library is not available.");
    }
});

// Populate year dropdown with the last 20 years
function populateYearDropdown() {
    const currentYear = new Date().getFullYear();
    const yearSelect = document.getElementById('startYear');
    
    // Clear existing options
    yearSelect.innerHTML = '';
    
    // Add last 20 years
    for (let year = currentYear; year >= currentYear - 20; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
    
    // Set default to current year
    yearSelect.value = currentYear;
}

// Format currency for display
function formatCurrency(amount) {
    return '₹' + amount.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Format currency without symbol for export
function formatCurrencyRaw(amount) {
    return amount.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Format percentage for display
function formatPercentage(value) {
    return value.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + '%';
}

// Format percentage without symbol for export
function formatPercentageRaw(value) {
    return value.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Format date for display
function formatDate(date) {
    return date.toLocaleDateString('en-IN', {
        month: 'short',
        year: 'numeric'
    });
}

// Format date for export
function formatDateForExport(date) {
    return date.toLocaleDateString('en-IN', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });
}

// Get the number of months between two dates
function getMonthDifference(startDate, endDate) {
    return (endDate.getFullYear() - startDate.getFullYear()) * 12 + 
           endDate.getMonth() - startDate.getMonth();
}

// Update the donut chart
function updateChart(loanAmount, totalInterest) {
    try {
        const ctx = document.getElementById('loanChart').getContext('2d');
        
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            return;
        }
        
        // Destroy previous chart instance if it exists
        if (loanChart) {
            loanChart.destroy();
        }
        
        // Create new chart
        loanChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Principal Amount', 'Total Interest'],
                datasets: [{
                    data: [loanAmount, totalInterest],
                    backgroundColor: ['#4F9DFF', '#8A4FFF'],
                    borderColor: ['rgba(79, 157, 255, 0.8)', 'rgba(138, 79, 255, 0.8)'],
                    borderWidth: 1,
                    hoverOffset: 8
                }]
            },
            options: {
                cutout: '65%',
                responsive: true,
                maintainAspectRatio: true,
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = Math.round((value / (loanAmount + totalInterest)) * 100);
                                return `${context.label}: ${formatCurrency(value).replace('₹', '')} (${percentage}%)`;
                            }
                        },
                        backgroundColor: 'rgba(42, 42, 42, 0.95)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            family: "'League Spartan', sans-serif"
                        },
                        bodyFont: {
                            size: 14,
                            family: "'League Spartan', sans-serif"
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                }
            }
        });
    } catch (error) {
        console.error("Chart creation error:", error);
    }
}

// Calculate EMI and generate repayment schedule
function calculateEMI() {
    // Show loading state
    var calculateBtn = document.getElementById('calculateBtn');
    calculateBtn.innerHTML = '<span class="loader"></span> Processing...';
    calculateBtn.disabled = true;
    
    // Get input values
    var loanAmount = parseFloat(document.getElementById('loanAmount').value);
    var interestRate = parseFloat(document.getElementById('interestRate').value);
    var loanTerm = parseInt(document.getElementById('loanTerm').value);
    var startMonth = parseInt(document.getElementById('startMonth').value);
    var startYear = parseInt(document.getElementById('startYear').value);
    
    // Validate inputs
    if (isNaN(loanAmount) || isNaN(interestRate) || isNaN(loanTerm) || 
        loanAmount <= 0 || interestRate <= 0 || loanTerm <= 0) {
        alert('Please enter valid positive values for all fields.');
        calculateBtn.innerHTML = 'Calculate EMI';
        calculateBtn.disabled = false;
        return;
    }
    
    // Create loan start date
    var loanStartDate = new Date(startYear, startMonth, 1);
    
    // Get current date (for paid/pending status)
    var currentDate = new Date();
    // Normalize to the 1st of the month for accurate comparison
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    
    // Calculate monthly interest rate
    var monthlyInterestRate = (interestRate / 100) / 12;
    
    // Calculate EMI using formula: EMI = P * r * (1 + r)^n / ((1 + r)^n - 1)
    var emi = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, loanTerm) / 
            (Math.pow(1 + monthlyInterestRate, loanTerm) - 1);
    
    // Generate repayment schedule
    var schedule = [];
    var remainingBalance = loanAmount;
    var totalInterestPaid = 0;
    var totalPrincipalPaid = 0;
    
    for (var month = 1; month <= loanTerm; month++) {
        // Calculate interest for this month
        var interestForMonth = remainingBalance * monthlyInterestRate;
        
        // Calculate principal for this month
        var principalForMonth = emi - interestForMonth;
        
        // Update remaining balance
        remainingBalance = Math.max(0, remainingBalance - principalForMonth);
        
        // Update total interest paid
        totalInterestPaid += interestForMonth;
        totalPrincipalPaid += principalForMonth;
        
        // Calculate payment date
        var paymentDate = new Date(loanStartDate);
        paymentDate.setMonth(loanStartDate.getMonth() + month);
        
        // Determine payment status
        var status = "pending";
        if (paymentDate < currentDate) {
            status = "paid";
        } else if (paymentDate.getMonth() === currentDate.getMonth() && 
                 paymentDate.getFullYear() === currentDate.getFullYear()) {
            status = "current";
        }
        
        // Add to schedule
        schedule.push({
            month: month,
            date: paymentDate,
            emi: emi,
            principal: principalForMonth,
            interest: interestForMonth,
            balance: remainingBalance,
            totalInterestPaid: totalInterestPaid,
            totalPrincipalPaid: totalPrincipalPaid,
            status: status
        });
        
        // If balance becomes zero or negligible, exit loop
        if (remainingBalance < 0.01) {
            remainingBalance = 0;
            schedule[schedule.length - 1].balance = 0;
            break;
        }
    }
    
    // Display results
    // Display monthly EMI
    document.getElementById('monthlyEMI').textContent = formatCurrency(emi);
    
    // Calculate and display total values
    var totalPayment = emi * schedule.length;
    var totalInterest = totalPayment - loanAmount;
    var interestRatio = (totalInterest / loanAmount) * 100;
    
    document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
    document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
    document.getElementById('interestRatio').textContent = formatPercentage(interestRatio);
    
    // Update the loan breakdown values
    document.getElementById('principalValue').textContent = formatCurrency(loanAmount);
    document.getElementById('interestValue').textContent = formatCurrency(totalInterest);
    document.getElementById('totalValue').textContent = formatCurrency(totalPayment);
    
    // Calculate and display percentages
    var principalPercent = Math.round((loanAmount / totalPayment) * 100);
    var interestPercent = Math.round((totalInterest / totalPayment) * 100);
    
    document.getElementById('principalPercentage').textContent = principalPercent + '%';
    document.getElementById('interestPercentage').textContent = interestPercent + '%';
    
    // Update progress information
    updateLoanProgress(schedule, loanStartDate, loanTerm, loanAmount);
    
    // Update the donut chart
    updateChart(loanAmount, totalInterest);
    
    // Display schedule in table
    displayRepaymentSchedule(schedule);
    
    // Store calculation results for export
    calculationResults = {
        loanAmount: loanAmount,
        interestRate: interestRate,
        loanTerm: loanTerm,
        startMonth: startMonth,
        startYear: startYear,
        emi: emi,
        totalPayment: totalPayment,
        totalInterest: totalInterest,
        interestRatio: interestRatio,
        schedule: schedule,
        calculationDate: new Date()
    };
    
    // Show results and enable export button
    document.getElementById('results').style.display = 'block';
    document.getElementById('exportBtn').disabled = false;
    
    // Scroll to results
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    
    // Restore button state
    calculateBtn.innerHTML = 'Calculate EMI';
    calculateBtn.disabled = false;
}

// Update loan progress section
function updateLoanProgress(schedule, startDate, loanTerm, loanAmount) {
    // Get dates for display
    var endDate = new Date(startDate);
    endDate.setMonth(startDate.getMonth() + loanTerm);
    
    // Display start, current, and end dates
    document.getElementById('loanStartDate').textContent = formatDate(startDate);
    document.getElementById('currentDate').textContent = formatDate(new Date());
    document.getElementById('loanEndDate').textContent = formatDate(endDate);
    
    // Calculate months completed and remaining
    var currentDate = new Date();
    var monthsElapsed = getMonthDifference(startDate, currentDate);
    monthsElapsed = Math.min(Math.max(0, monthsElapsed), loanTerm); // Ensure between 0 and loan term
    var monthsRemaining = loanTerm - monthsElapsed;
    
    // Update progress bar
    var progressPercentage = (monthsElapsed / loanTerm) * 100;
    document.getElementById('progressBar').style.width = progressPercentage + '%';
    
    // Update months completed/remaining
    document.getElementById('monthsCompleted').textContent = monthsElapsed;
    document.getElementById('monthsRemaining').textContent = monthsRemaining;
    
    // Calculate and display principal paid/remaining
    var principalPaid = 0;
    var principalRemaining = loanAmount;
    
    if (schedule.length > 0) {
        // Find the last paid or current installment
        for (var i = 0; i < schedule.length; i++) {
            if (schedule[i].status === 'paid' || schedule[i].status === 'current') {
                principalPaid = schedule[i].totalPrincipalPaid;
                principalRemaining = loanAmount - principalPaid;
            }
            if (schedule[i].status === 'pending') {
                break;
            }
        }
    }
    
    document.getElementById('principalPaid').textContent = formatCurrency(principalPaid);
    document.getElementById('principalRemaining').textContent = formatCurrency(principalRemaining);
}

// Display repayment schedule in table
function displayRepaymentSchedule(schedule) {
    var tableBody = document.getElementById('scheduleBody');
    tableBody.innerHTML = '';
    
    for (var i = 0; i < schedule.length; i++) {
        var payment = schedule[i];
        
        var row = document.createElement('tr');
        
        // Add class based on payment status
        if (payment.status === 'paid') {
            row.classList.add('paid-row');
        } else if (payment.status === 'current') {
            row.classList.add('current-row');
        }
        
        // Get status display text and class
        var statusHtml = '';
        if (payment.status === 'paid') {
            statusHtml = '<span class="status-badge badge-paid">Paid</span>';
        } else if (payment.status === 'current') {
            statusHtml = '<span class="status-badge badge-current">Current</span>';
        } else {
            statusHtml = '<span class="status-badge badge-pending">Pending</span>';
        }
        
        row.innerHTML = 
            '<td class="text-center">' + payment.month + '</td>' +
            '<td>' + formatDate(payment.date) + '</td>' +
            '<td class="text-center">' + statusHtml + '</td>' +
            '<td class="text-right">' + formatCurrency(payment.emi) + '</td>' +
            '<td class="text-right principal-amount">' + formatCurrency(payment.principal) + '</td>' +
            '<td class="text-right interest-amount">' + formatCurrency(payment.interest) + '</td>' +
            '<td class="text-right">' + formatCurrency(payment.balance) + '</td>';
        
        tableBody.appendChild(row);
    }
}

// Export repayment schedule to Excel (CSV)
function exportToExcel() {
    if (!calculationResults || !calculationResults.schedule) {
        alert("Please calculate EMI first before exporting.");
        return;
    }
    
    // Show loading state
    var exportBtn = document.getElementById('exportBtn');
    exportBtn.innerHTML = '<span class="loader"></span> Exporting...';
    exportBtn.disabled = true;
    
    try {
        // Get loan details from stored calculation results
        const loanAmount = calculationResults.loanAmount;
        const interestRate = calculationResults.interestRate;
        const loanTerm = calculationResults.loanTerm;
        const startMonth = calculationResults.startMonth;
        const startYear = calculationResults.startYear;
        const emi = calculationResults.emi;
        const totalInterest = calculationResults.totalInterest;
        const totalPayment = calculationResults.totalPayment;
        const interestRatio = calculationResults.interestRatio;
        const schedule = calculationResults.schedule;
        
        // Get current date for the report
        const reportDate = formatDateForExport(new Date());
        
        // Properly escape CSV values
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            
            let result = String(value);
            // If the value contains a comma, quote, or newline, wrap it in quotes
            if (result.includes(',') || result.includes('"') || result.includes('\n')) {
                // Double up any quotes
                result = result.replace(/"/g, '""');
                // Wrap in quotes
                result = `"${result}"`;
            }
            return result;
        }
        
        // Create CSV content with proper structure
        let csvContent = [];
        
        // Title and branding
        csvContent.push(['Ledgica Private Limited - EMI Loan Repayment Schedule']);
        csvContent.push(['Report Generated', reportDate]);
        csvContent.push([]);  // Empty row for spacing
        
        // Loan details section
        csvContent.push(['Loan Details']);
        csvContent.push(['Loan Amount', formatCurrencyRaw(loanAmount)]);
        csvContent.push(['Annual Interest Rate', formatPercentageRaw(interestRate) + '%']);
        csvContent.push(['Loan Term', loanTerm + ' months (' + (loanTerm / 12).toFixed(1) + ' years)']);
        
        // Get the loan start date in readable format
        const startDate = new Date(startYear, startMonth, 1);
        csvContent.push(['Loan Start Date', formatDate(startDate)]);
        csvContent.push([]);  // Empty row for spacing
        
        // Loan progress section
        const currentDate = new Date();
        const monthsElapsed = Math.min(getMonthDifference(startDate, currentDate), loanTerm);
        const monthsRemaining = loanTerm - monthsElapsed;
        
        csvContent.push(['Loan Progress']);
        csvContent.push(['Months Completed', monthsElapsed]);
        csvContent.push(['Months Remaining', monthsRemaining]);
        csvContent.push(['Completion Percentage', formatPercentageRaw(monthsElapsed / loanTerm * 100) + '%']);
        csvContent.push([]);  // Empty row for spacing
        
        // Summary section
        csvContent.push(['Loan Summary']);
        csvContent.push(['Monthly EMI', formatCurrencyRaw(emi)]);
        csvContent.push(['Total Interest Payable', formatCurrencyRaw(totalInterest)]);
        csvContent.push(['Total Amount Payable', formatCurrencyRaw(totalPayment)]);
        csvContent.push(['Interest to Principal Ratio', formatPercentageRaw(interestRatio) + '%']);
        csvContent.push([]);  // Empty row for spacing
        
        // Repayment schedule header
        csvContent.push(['Repayment Schedule']);
        csvContent.push(['No.', 'Payment Date', 'Status', 'EMI', 'Principal', 'Interest', 'Balance']);
        
        // Add schedule rows
        schedule.forEach(payment => {
            csvContent.push([
                payment.month,
                formatDate(payment.date),
                payment.status.charAt(0).toUpperCase() + payment.status.slice(1), // Capitalize first letter
                formatCurrencyRaw(payment.emi),
                formatCurrencyRaw(payment.principal),
                formatCurrencyRaw(payment.interest),
                formatCurrencyRaw(payment.balance)
            ]);
        });
        
        // Add footer
        csvContent.push([]);
        csvContent.push(['© ' + new Date().getFullYear() + ' Ledgica Private Limited. All rights reserved.']);
        
        // Convert to CSV string
        const csvString = csvContent.map(row => 
            row.map(cell => escapeCSV(cell)).join(',')
        ).join('\n');
        
        // Add UTF-8 BOM to ensure Excel opens it correctly
        const BOM = "\uFEFF";
        const csvData = BOM + csvString;
        
        // Create file and trigger download
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const fileName = 'Ledgica_Loan_Repayment_Schedule_' + new Date().toISOString().slice(0, 10) + '.csv';
        
        // Create download link and trigger download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = fileName;
        
        // Add to DOM, trigger click, and remove
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Restore button state
        setTimeout(() => {
            exportBtn.innerHTML = 'Export to Excel';
            exportBtn.disabled = false;
        }, 1000);
    } catch (error) {
        console.error('Export error:', error);
        alert('An error occurred during export. Please try again.');
        
        // Restore button state
        exportBtn.innerHTML = 'Export to Excel';
        exportBtn.disabled = false;
    }
}
</script>
</body>
</html>